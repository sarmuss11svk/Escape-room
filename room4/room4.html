<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Úloha IST – Sieť z tmy (FIX)</title>
<style>
  :root{
    --bg1:#010409; --bg2:#020617; --panel:#0b1220; --cyan:#00f0ff; --accent:#ff6b6b;
    --ok:#4caf50; --warn:#ff9800; --err:#ff6464; --text:#e8f3ff; --muted:#94a3b8;
  }
  *{box-sizing:border-box;font-family:'Segoe UI',system-ui,-apple-system,Arial}
  body{margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text);min-height:100vh;overflow-x:hidden}
  header{text-align:center;padding:28px 16px 8px}
  h1{margin:0 0 8px;font-size:2rem;text-shadow:0 0 18px #000}
  p.lead{opacity:.9;margin:0 auto;max-width:900px}
  .wrap{max-width:1200px;margin:14px auto 90px;padding:0 12px}
  .stage{background:rgba(255,255,255,.06);border:1px solid #0ff3;border-radius:14px;box-shadow:0 0 24px #00f5ff22;padding:16px;margin-top:14px}
  .stage h2{margin:0 0 6px;font-size:1.15rem;color:#a7f3ff}
  .hint{font-size:.95rem;opacity:.95}
  .grid{display:grid;grid-template-columns:1.3fr .7fr;gap:16px;align-items:stretch}
  .pad{position:relative;background:rgba(0,0,0,.35);border:1px dashed #0ff5;border-radius:12px;min-height:470px;overflow:hidden}
  /* uzly */
  .node{
    position:absolute;z-index:2;display:flex;flex-direction:column;align-items:center;justify-content:center;
    width:140px;height:88px;border-radius:12px;border:2px solid #334155;background:radial-gradient(ellipse at top,#111,#1f2937);
    box-shadow:0 6px 18px #0006,0 0 12px #00ffff22;cursor:pointer;user-select:none;transition:.2s transform,.2s box-shadow
  }
  .node:hover{transform:translateY(-2px);box-shadow:0 10px 24px #0008,0 0 18px #00ffff55}
  .node.selected{outline:2px solid var(--cyan);box-shadow:0 0 30px #00ffff88}
  .name{font-weight:700}
  .badge{font-size:.76rem;color:#cbd5e1}
  .port{position:absolute;bottom:6px;left:6px;font-size:.7rem;color:#9fb3d1;opacity:.9}
  /* legenda + ovládanie */
  .legend{padding:10px;background:rgba(255,255,255,.05);border-radius:10px}
  .legend p{margin:.35rem 0}
  .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:#0ea5e9;margin-left:6px;font-size:.75rem}
  .controls{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap;align-items:center}
  button{
    background:linear-gradient(135deg,var(--accent),#ff8787);border:none;color:#fff;border-radius:10px;
    padding:9px 14px;font-size:1rem;cursor:pointer;transition:.15s transform,.15s filter
  }
  button:hover{transform:scale(1.02)}
  button.sec{background:#1f2937}
  button.ok{background:linear-gradient(135deg,var(--ok),#7ad57b)}
  .status{margin-top:8px;font-size:.95rem}
  .status.ok{color:#b7ffbf}.status.err{color:#ffb4b4}.status.warn{color:#ffd48f}.muted{color:#94a3b8}
  /* spojnice */
  svg{position:absolute;inset:0;z-index:1}
  line.link{stroke:#38bdf8;stroke-width:3;filter:drop-shadow(0 0 6px #38bdf8)}
  line.link.bad{stroke:#f87171;filter:drop-shadow(0 0 6px #f87171)}
  line.link.opt{stroke:#d8b4fe;filter:drop-shadow(0 0 6px #d8b4fe)}
  /* Stage 2 */
  .formgrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;margin-top:12px}
  .card{background:var(--panel);border:1px solid #1f2b44;border-radius:12px;padding:12px}
  .card h3{margin:.2rem 0 .6rem;font-size:1rem;color:#a7f3ff}
  .row{display:flex;gap:8px;align-items:center;margin:6px 0}
  label{width:86px;font-size:.9rem;color:#c7d2fe}
  input{
    width:100%;padding:8px 10px;border-radius:8px;border:1px solid #334155;background:#0b1220;color:#fff
  }
  .calc{margin-top:8px;padding:10px;border-radius:10px;background:rgba(0,0,0,.35)}
  .calc input{width:auto;min-width:140px}
  .result{margin-top:8px;padding:10px;border-radius:10px;background:rgba(0,0,0,.35);font-family:ui-monospace,Consolas,monospace;white-space:pre-line}
  /* Stage 3 */
  .termwrap{display:grid;grid-template-columns:1fr 360px;gap:12px}
  .terminal{background:#070b12;border:1px solid #11203a;border-radius:12px;padding:12px;font-family:ui-monospace,Consolas,monospace;min-height:280px}
  .terminal pre{margin:0;white-space:pre-wrap}
  .term-input{display:flex;gap:8px;margin-top:8px}
  .term-input input{flex:1}
  .side{background:var(--panel);border:1px solid #1f2b44;border-radius:12px;padding:12px}
  .side h3{margin:.2rem 0 .6rem;color:#a7f3ff}
  .mini{font-size:.92rem}
  .score{margin-top:8px}
  .next{display:none;margin-top:14px}
  .back{position:fixed;left:50%;transform:translateX(-50%);bottom:12px;background:var(--accent)}
  /* modal výber kábla */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:999}
  .modal .box{background:#0b1220;border:1px solid #1f2b44;border-radius:12px;padding:16px;max-width:360px;width:92%}
  .choice{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .choice button{flex:1;min-width:130px}
</style>
</head>
<body>
<header>
  <h1>⚡ Sieť z tmy (FIX)</h1>
  <p class="lead">1) Správne pospájaj zariadenia a zvoľ káble. 2) Nakonfiguruj IP adresy & brány. 3) Over ping/traceroute v termináli.</p>
</header>

<div class="wrap">
  <!-- STAGE 1 -->
  <section class="stage" id="stage1">
    <h2>1) Topológia + typy káblov</h2>
    <p class="hint">Klikni na <b>prvé</b> zariadenie, potom na <b>druhé</b>. Zjaví sa výber kábla. Potrebné spoje: PC1–SWA, PC2–SWA, R1–SWA, SWB–Server, SWA–SWB (crossover alebo SFP).</p>
    <div class="grid">
      <div class="pad" id="pad">
        <svg id="wires" aria-hidden="true"></svg>
        <!-- zariadenia -->
        <div class="node" id="router" style="left:calc(50% - 70px); top:22px;">
          <div class="name">Router</div>
          <div class="badge">R1</div>
          <div class="port">G0/0 • G0/1 • CON</div>
        </div>
        <div class="node" id="switchA" style="left:120px; top:160px;">
          <div class="name">Switch A</div>
          <div class="badge">SWA</div>
          <div class="port">Fa • SFP</div>
        </div>
        <div class="node" id="switchB" style="right:120px; top:160px;">
          <div class="name">Switch B</div>
          <div class="badge">SWB</div>
          <div class="port">Fa • SFP</div>
        </div>
        <div class="node" id="pc1" style="left:40px; bottom:26px;">
          <div class="name">PC1</div>
          <div class="badge">host</div>
          <div class="port">NIC</div>
        </div>
        <div class="node" id="pc2" style="left:220px; bottom:26px;">
          <div class="name">PC2</div>
          <div class="badge">host</div>
          <div class="port">NIC</div>
        </div>
        <div class="node" id="server" style="right:40px; bottom:26px;">
          <div class="name">Server</div>
          <div class="badge">SRV</div>
          <div class="port">NIC</div>
        </div>
      </div>
      <div class="legend">
        <p><b>Typy káblov</b> <span class="pill">UTP straight</span> <span class="pill">UTP crossover</span> <span class="pill">SFP optika</span> <span class="pill">Konzola</span></p>
        <div class="controls">
          <button class="sec" id="undoLink">Zruš posledný spoj</button>
          <button class="sec" id="resetStage1">Reset topológie</button>
          <button class="ok" id="lockStage1">Over & pokračuj</button>
        </div>
        <div id="stage1Status" class="status muted">Vyber dve zariadenia a následne typ kábla.</div>
      </div>
    </div>
  </section>

  <!-- STAGE 2 -->
  <section class="stage" id="stage2" style="display:none">
    <h2>2) IP konfigurácia + kalkulačka</h2>
    <p class="hint">Schéma: <b>192.168.1.0/24</b> (PC1, PC2, SWA mgmt, R1 G0/0) • <b>192.168.2.0/24</b> (Server, SWB mgmt, R1 G0/1).</p>
    <div class="formgrid" id="ipForms">
      <div class="card">
        <h3>Router R1</h3>
        <div class="row"><label>G0/0 IP</label><input id="r_g00_ip" placeholder="192.168.1.1"></div>
        <div class="row"><label>G0/0 maska</label><input id="r_g00_m" placeholder="255.255.255.0"></div>
        <div class="row"><label>G0/1 IP</label><input id="r_g01_ip" placeholder="192.168.2.1"></div>
        <div class="row"><label>G0/1 maska</label><input id="r_g01_m" placeholder="255.255.255.0"></div>
      </div>
      <div class="card">
        <h3>Switch A – mgmt</h3>
        <div class="row"><label>IP</label><input id="swa_ip" placeholder="192.168.1.2"></div>
        <div class="row"><label>Maska</label><input id="swa_m" placeholder="255.255.255.0"></div>
        <div class="row"><label>Brána</label><input id="swa_gw" placeholder="192.168.1.1"></div>
      </div>
      <div class="card">
        <h3>Switch B – mgmt</h3>
        <div class="row"><label>IP</label><input id="swb_ip" placeholder="192.168.2.2"></div>
        <div class="row"><label>Maska</label><input id="swb_m" placeholder="255.255.255.0"></div>
        <div class="row"><label>Brána</label><input id="swb_gw" placeholder="192.168.2.1"></div>
      </div>
      <div class="card">
        <h3>PC1</h3>
        <div class="row"><label>IP</label><input id="pc1_ip" placeholder="192.168.1.10"></div>
        <div class="row"><label>Maska</label><input id="pc1_m" placeholder="255.255.255.0"></div>
        <div class="row"><label>Brána</label><input id="pc1_gw" placeholder="192.168.1.1"></div>
      </div>
      <div class="card">
        <h3>PC2</h3>
        <div class="row"><label>IP</label><input id="pc2_ip" placeholder="192.168.1.11"></div>
        <div class="row"><label>Maska</label><input id="pc2_m" placeholder="255.255.255.0"></div>
        <div class="row"><label>Brána</label><input id="pc2_gw" placeholder="192.168.1.1"></div>
      </div>
      <div class="card">
        <h3>Server</h3>
        <div class="row"><label>IP</label><input id="srv_ip" placeholder="192.168.2.100"></div>
        <div class="row"><label>Maska</label><input id="srv_m" placeholder="255.255.255.0"></div>
        <div class="row"><label>Brána</label><input id="srv_gw" placeholder="192.168.2.1"></div>
      </div>
    </div>

    <div class="calc">
      <b>IP kalkulačka</b>
      <div class="row">
        <label>IP</label><input id="calc_ip" placeholder="192.168.1.10">
        <label>Maska</label><input id="calc_mask" placeholder="255.255.255.0">
        <button class="sec" id="doCalc">Vypočítaj</button>
      </div>
      <div class="result" id="calc_out">Sieťová adresa, broadcast, hostia…</div>
    </div>

    <div class="controls">
      <button class="sec" id="loadDefaults">Vyplniť správne adresy</button>
      <button class="ok" id="lockStage2">Over & pokračuj</button>
    </div>
    <div id="stage2Status" class="status muted">Zadaj IP/masky/brány podľa dvoch podsietí. Všetko musí byť v správnej sieti; brány smerovať na IP routera v danej sieti.</div>
  </section>

  <!-- STAGE 3 -->
  <section class="stage" id="stage3" style="display:none">
    <h2>3) Terminál – ping & traceroute</h2>
    <p class="hint">Príkazy: <code>ping &lt;IP&gt;</code>, <code>traceroute &lt;IP&gt;</code>, <code>show links</code>, <code>show ip</code>, <code>reset</code>. Zdroj pingu si vyber vpravo.</p>
    <div class="termwrap">
      <div>
        <div class="terminal" id="terminal">
          <pre id="termOut">[BOOT] Sieťový terminál inicializovaný.
Napíš napríklad: ping 192.168.2.100</pre>
        </div>
        <div class="term-input">
          <input id="termIn" placeholder="> príkaz" />
          <button id="runCmd">Spustiť</button>
          <button class="sec" id="clearTerm">Vyčistiť</button>
        </div>
      </div>
      <div class="side">
        <h3>Zdroj pingu</h3>
        <select id="srcHost">
          <option value="pc1">PC1 (192.168.1.10)</option>
          <option value="pc2">PC2 (192.168.1.11)</option>
          <option value="srv">Server (192.168.2.100)</option>
        </select>
        <div class="score">
          <p><b>Skóre</b>: <span id="score">0</span> / 100</p>
          <p id="stage3Status" class="muted mini">Cieľ: úspešný ping z PC1 → Server.</p>
          <button class="ok next" id="finishBtn">Dokončiť misiu</button>
        </div>
      </div>
    </div>
  </section>
</div>

<button class="back" onclick="history.back()">⬅ Späť</button>

<!-- Modal pre výber kábla -->
<div class="modal" id="cableModal" role="dialog" aria-modal="true">
  <div class="box">
    <h3>Vyber typ kábla</h3>
    <div class="choice">
      <button data-cable="straight">UTP straight</button>
      <button data-cable="crossover">UTP crossover</button>
      <button data-cable="sfp">SFP optika</button>
      <button data-cable="console">Konzolový</button>
    </div>
    <div style="margin-top:10px;text-align:right">
      <button class="sec" id="cancelCable">Zrušiť</button>
    </div>
  </div>
</div>

<script>
/* ===== štát ===== */
const State = {
  requiredLinks: [
    ['pc1','switchA','straight'],
    ['pc2','switchA','straight'],
    ['router','switchA','straight'],
    ['switchA','switchB','crossover|sfp'],
    ['switchB','server','straight'],
  ],
  links: [],
  stage1Locked:false,
  ipcfg:{},
  stage2Locked:false,
  score:0
};
const $=sel=>document.querySelector(sel);
const pad=$('#pad'), wires=$('#wires');
const nodes=['router','switchA','switchB','pc1','pc2','server'];
function pos(){ return Object.fromEntries(nodes.map(id=>{ const el=$('#'+id), r=el.getBoundingClientRect(), p=pad.getBoundingClientRect(); return [id,{x:r.left-p.left+r.width/2,y:r.top-p.top+r.height/2}]; }));}
function drawLinks(){ wires.innerHTML=''; const P=pos(); State.links.forEach(L=>{ const ln=document.createElementNS('http://www.w3.org/2000/svg','line'); ln.classList.add('link'); if(L.type==='sfp') ln.classList.add('opt'); if(L.bad) ln.classList.add('bad'); ln.setAttribute('x1',P[L.a].x); ln.setAttribute('y1',P[L.a].y); ln.setAttribute('x2',P[L.b].x); ln.setAttribute('y2',P[L.b].y); wires.appendChild(ln); });}
window.addEventListener('resize',drawLinks);

/* ===== výber uzlov + modal kábla ===== */
let selA=null, pendingPair=null;
nodes.forEach(id=>{
  const el=$('#'+id);
  el.addEventListener('click',()=>{
    if(State.stage1Locked) return;
    if(selA===id){ el.classList.remove('selected'); selA=null; return; }
    if(!selA){ selA=id; el.classList.add('selected'); return; }
    const a=selA, b=id;
    $('#'+a).classList.remove('selected'); selA=null;
    if(a===b){ setStatus1('Nemôžeš spojiť zariadenie samo so sebou.', 'err'); return; }
    if(State.links.some(L=>(L.a===a&&L.b===b)||(L.a===b&&L.b===a))){ setStatus1('Tieto zariadenia už sú spojené.', 'err'); return; }
    // Otvor modal a ulož dvojicu
    pendingPair=[a,b];
    openCableModal();
  });
});

function openCableModal(){ $('#cableModal').style.display='flex'; }
function closeCableModal(){ $('#cableModal').style.display='none'; pendingPair=null; }
$('#cancelCable').addEventListener('click',closeCableModal);
document.querySelectorAll('.choice button').forEach(btn=>{
  btn.addEventListener('click',()=>{
    if(!pendingPair) return;
    const [a,b]=pendingPair, type=btn.dataset.cable;
    const ok = validateCable(a,b,type);
    State.links.push({a,b,type,bad:!ok});
    drawLinks();
    updateStage1Status();
    setStatus1(ok?'Spoj vytvorený.':'Nesprávny typ kábla pre túto dvojicu.','warn');
    closeCableModal();
  });
});

function pair(a,b){ return [a,b].sort().join('-'); }
function validateCable(a,b,type){
  const p = pair(a,b);
  const rules = {
    [pair('pc1','switchA')]       : 'straight',
    [pair('pc2','switchA')]       : 'straight',
    [pair('router','switchA')]    : 'straight',
    [pair('switchA','switchB')]   : 'crossover|sfp',
    [pair('switchB','server')]    : 'straight',
  };
  if(type==='console') return false;
  if(!rules[p]) return false;
  const need = rules[p];
  return need.split('|').includes(type);
}

function updateStage1Status(){
  let good=0;
  for(const req of State.requiredLinks){
    const [x,y,typ]=req;
    const found = State.links.find(L=>{
      const okpair=(L.a===x&&L.b===y)||(L.a===y&&L.b===x);
      const oktyp= typ.includes('|') ? typ.split('|').includes(L.type) : L.type===typ;
      return okpair && oktyp;
    });
    if(found) good++;
  }
  const need=State.requiredLinks.length;
  setStatus1(`Správne spoje: ${good} / ${need}. ${good===need?'Výborne! Môžeš pokračovať.':''}`, good===need?'ok':'warn');
}
function setStatus1(text, kind='muted'){
  const el=$('#stage1Status'); el.textContent=text; el.className='status '+(kind==='ok'?'ok':kind==='warn'?'warn':kind==='err'?'err':'muted');
}

$('#undoLink').addEventListener('click',()=>{ if(State.stage1Locked) return; State.links.pop(); drawLinks(); updateStage1Status(); });
$('#resetStage1').addEventListener('click',()=>{ if(State.stage1Locked) return; State.links=[]; drawLinks(); updateStage1Status(); });
$('#lockStage1').addEventListener('click',()=>{
  const need=State.requiredLinks.length;
  let good=0;
  for(const req of State.requiredLinks){
    const [x,y,typ]=req;
    const found = State.links.find(L=>{
      const okpair=(L.a===x&&L.b===y)||(L.a===y&&L.b===x);
      const oktyp= typ.includes('|') ? typ.split('|').includes(L.type) : L.type===typ;
      return okpair && oktyp;
    });
    if(found) good++;
  }
  if(good!==need){ setStatus1('Ešte nemáš všetky potrebné spoje.','err'); return; }
  State.stage1Locked=true;
  document.getElementById('stage1').style.display='none';
  document.getElementById('stage2').style.display='block';
});

/* ===== Stage 2 – IP nástroje ===== */
const Net={
  ip2int(ip){ const p=ip.split('.').map(x=>+x); if(p.length!==4||p.some(isNaN)||p.some(x=>x<0||x>255)) return null; return (p[0]<<24)|(p[1]<<16)|(p[2]<<8)|p[3]; },
  int2ip(n){ return [(n>>>24)&255,(n>>>16)&255,(n>>>8)&255,(n)&255].join('.'); },
  mask2int(m){ return this.ip2int(m); },
  network(ip,mask){ const I=this.ip2int(ip), M=this.mask2int(mask); if(I==null||M==null) return null; return I & M; },
  broadcast(ip,mask){ const I=this.ip2int(ip), M=this.mask2int(mask); if(I==null||M==null) return null; return (I & M) | (~M >>>0); },
  inSameNet(ip1,ip2,mask){ const n1=this.network(ip1,mask), n2=this.network(ip2,mask); return n1!=null && n1===n2; },
  validHost(ip,mask){ const I=this.ip2int(ip), N=this.network(ip,mask), B=this.broadcast(ip,mask); if(I==null||N==null||B==null) return false; return I>N && I<B; }
};
function fillDefaults(){
  const set=(id,val)=>{ const el=$(id); if(el) el.value=val; };
  set('#r_g00_ip','192.168.1.1'); set('#r_g00_m','255.255.255.0');
  set('#r_g01_ip','192.168.2.1'); set('#r_g01_m','255.255.255.0');
  set('#swa_ip','192.168.1.2'); set('#swa_m','255.255.255.0'); set('#swa_gw','192.168.1.1');
  set('#swb_ip','192.168.2.2'); set('#swb_m','255.255.255.0'); set('#swb_gw','192.168.2.1');
  set('#pc1_ip','192.168.1.10'); set('#pc1_m','255.255.255.0'); set('#pc1_gw','192.168.1.1');
  set('#pc2_ip','192.168.1.11'); set('#pc2_m','255.255.255.0'); set('#pc2_gw','192.168.1.1');
  set('#srv_ip','192.168.2.100'); set('#srv_m','255.255.255.0'); set('#srv_gw','192.168.2.1');
}
fillDefaults();

$('#doCalc').addEventListener('click',()=>{
  const ip=$('#calc_ip').value.trim(), m=$('#calc_mask').value.trim();
  const n=Net.network(ip,m), b=Net.broadcast(ip,m);
  if(n==null||b==null){ $('#calc_out').textContent='Neplatná IP alebo maska.'; return;}
  const hostCount = Math.max(0, (0xFFFFFFFF - Net.mask2int(m) - 1) );
  $('#calc_out').textContent = `Sieťová: ${Net.int2ip(n)}\nBroadcast: ${Net.int2ip(b)}\nHostia: ${hostCount}`;
});

$('#lockStage2').addEventListener('click',()=>{
  const c=readCfg();
  if(!Net.inSameNet(c.r_g00.ip, '192.168.1.1', c.r_g00.m) || !Net.validHost(c.r_g00.ip, c.r_g00.m)){
    return fail2('Router G0/0 musí byť v sieti 192.168.1.0/24 a platný host.');
  }
  if(!Net.inSameNet(c.r_g01.ip, '192.168.2.1', c.r_g01.m) || !Net.validHost(c.r_g01.ip, c.r_g01.m)){
    return fail2('Router G0/1 musí byť v sieti 192.168.2.0/24 a platný host.');
  }
  if(!Net.inSameNet(c.swa.ip,c.r_g00.ip,c.swa.m) || c.swa.gw!==c.r_g00.ip || !Net.validHost(c.swa.ip,c.swa.m)){
    return fail2('SWA musí byť v 192.168.1.0/24, brána = IP routera G0/0.');
  }
  if(!Net.inSameNet(c.swb.ip,c.r_g01.ip,c.swb.m) || c.swb.gw!==c.r_g01.ip || !Net.validHost(c.swb.ip,c.swb.m)){
    return fail2('SWB musí byť v 192.168.2.0/24, brána = IP routera G0/1.');
  }
  if(!Net.inSameNet(c.pc1.ip,c.r_g00.ip,c.pc1.m) || c.pc1.gw!==c.r_g00.ip || !Net.validHost(c.pc1.ip,c.pc1.m)){
    return fail2('PC1 má zlú sieť alebo bránu.');
  }
  if(!Net.inSameNet(c.pc2.ip,c.r_g00.ip,c.pc2.m) || c.pc2.gw!==c.r_g00.ip || !Net.validHost(c.pc2.ip,c.pc2.m)){
    return fail2('PC2 má zlú sieť alebo bránu.');
  }
  if(!Net.inSameNet(c.srv.ip,c.r_g01.ip,c.srv.m) || c.srv.gw!==c.r_g01.ip || !Net.validHost(c.srv.ip,c.srv.m)){
    return fail2('Server má zlú sieť alebo bránu.');
  }
  State.ipcfg=c; State.stage2Locked=true;
  document.getElementById('stage2').style.display='none';
  document.getElementById('stage3').style.display='block';
});
function fail2(msg){ const s=$('#stage2Status'); s.textContent=msg; s.className='status err'; }

function readCfg(){
  const g=id=>$(id)?.value?.trim()||'';
  return {
    r_g00:{ip:g('#r_g00_ip'), m:g('#r_g00_m')},
    r_g01:{ip:g('#r_g01_ip'), m:g('#r_g01_m')},
    swa:{ip:g('#swa_ip'), m:g('#swa_m'), gw:g('#swa_gw')},
    swb:{ip:g('#swb_ip'), m:g('#swb_m'), gw:g('#swb_gw')},
    pc1:{ip:g('#pc1_ip'), m:g('#pc1_m'), gw:g('#pc1_gw')},
    pc2:{ip:g('#pc2_ip'), m:g('#pc2_m'), gw:g('#pc2_gw')},
    srv:{ip:g('#srv_ip'), m:g('#srv_m'), gw:g('#srv_gw')}
  };
}

/* ===== Stage 3 – terminál ===== */
const termOut = $('#termOut'), termIn=$('#termIn');
$('#runCmd').addEventListener('click',()=>runCmd());
termIn.addEventListener('keydown',(e)=>{ if(e.key==='Enter') runCmd(); });
$('#clearTerm').addEventListener('click',()=>{ termOut.textContent=''; });
$('#finishBtn').addEventListener('click',()=>{
  println('[OK] Misia splnená. Sieť obnovená.');
});

function println(t=''){ termOut.textContent += (termOut.textContent ? '\n' : '') + t; termOut.scrollTop=termOut.scrollHeight; }
function runCmd(){
  const line = termIn.value.trim(); if(!line) return; println('> '+line); termIn.value='';
  const [cmd, ...rest] = line.split(/\s+/); const arg = rest.join(' ');
  switch(cmd.toLowerCase()){
    case 'ping': return doPing(arg);
    case 'traceroute': return doTrace(arg);
    case 'show': return doShow(rest);
    case 'reset': println('[OK] reset'); return;
    default: println('[ERR] Neznámy príkaz. Skús: ping, traceroute, show, reset.');
  }
}
function doShow(args){
  const sub=args[0]?.toLowerCase();
  if(sub==='links'){
    const lines = State.links.map(L=>`${L.a} <-> ${L.b} [${L.type}]`).join('\n');
    println(lines || '(žiadne)');
  } else if(sub==='ip'){
    const c=State.ipcfg;
    const out = [
      `R1 G0/0: ${c?.r_g00?.ip}/${c?.r_g00?.m}  G0/1: ${c?.r_g01?.ip}/${c?.r_g01?.m}`,
      `SWA mgmt: ${c?.swa?.ip} gw ${c?.swa?.gw}`,
      `SWB mgmt: ${c?.swb?.ip} gw ${c?.swb?.gw}`,
      `PC1: ${c?.pc1?.ip} gw ${c?.pc1?.gw}`,
      `PC2: ${c?.pc2?.ip} gw ${c?.pc2?.gw}`,
      `SRV: ${c?.srv?.ip} gw ${c?.srv?.gw}`,
    ].join('\n');
    println(out);
  } else {
    println('show links | show ip');
  }
}
function haveLink(a,b,types=null){
  const found = State.links.find(L=>{
    const okpair = (L.a===a && L.b===b) || (L.a===b && L.b===a);
    const oktype = !types ? true : types.includes(L.type);
    return okpair && oktype;
  });
  return !!found;
}
function currentSrc(){
  const sel=$('#srcHost').value;
  switch(sel){
    case 'pc1': return {id:'pc1', ip: State.ipcfg?.pc1?.ip, gw:State.ipcfg?.pc1?.gw, mask:State.ipcfg?.pc1?.m, net:1};
    case 'pc2': return {id:'pc2', ip: State.ipcfg?.pc2?.ip, gw:State.ipcfg?.pc2?.gw, mask:State.ipcfg?.pc2?.m, net:1};
    case 'srv': return {id:'server', ip: State.ipcfg?.srv?.ip, gw:State.ipcfg?.srv?.gw, mask:State.ipcfg?.srv?.m, net:2};
  }
}
function resolveDevByIp(ip){
  const c=State.ipcfg;
  if(ip===c?.pc1?.ip) return 'pc1';
  if(ip===c?.pc2?.ip) return 'pc2';
  if(ip===c?.srv?.ip) return 'server';
  if(ip===c?.r_g00?.ip) return 'router';
  if(ip===c?.r_g01?.ip) return 'router';
  if(ip===c?.swa?.ip) return 'switchA';
  if(ip===c?.swb?.ip) return 'switchB';
  return null;
}
function doPing(ip){
  if(!ip){ println('Použitie: ping <IP>'); return; }
  const src=currentSrc();
  if(!src?.ip){ println('[ERR] Zdroj nemá IP. Dokonči konfiguráciu.'); return; }
  const c=State.ipcfg;
  const targetDev = resolveDevByIp(ip);
  if(!targetDev){ println('Cieľ nie je v známej sieti.'); return; }
  const linksOk =
    haveLink('pc1','switchA',['straight']) &&
    haveLink('pc2','switchA',['straight']) &&
    haveLink('router','switchA',['straight']) &&
    haveLink('switchA','switchB',['crossover','sfp']) &&
    haveLink('switchB','server',['straight']);
  if(!linksOk){ println('Request timed out (zlé/nezapojené spoje).'); return; }
  const inNet=(ip,ifaceIp,mask)=>Net.inSameNet(ip, ifaceIp, mask);
  const okSrc = inNet(src.ip, c.r_g00.ip, c.r_g00.m) || inNet(src.ip, c.r_g01.ip, c.r_g01.m);
  const okDst = inNet(ip, c.r_g00.ip, c.r_g00.m) || inNet(ip, c.r_g01.ip, c.r_g01.m);
  if(!okSrc||!okDst){ println('Request timed out (mimo známych podsietí).'); return; }
  // simulácia RTT
  const rtt = Math.floor(2 + Math.random()*6);
  [1,2,3,4].forEach(n=>println(`Reply from ${ip}: bytes=32 time=${rtt}ms TTL=64`));
  println('[OK] Ping úspešný.');
  if($('#srcHost').value==='pc1' && targetDev==='server'){ $('#finishBtn').style.display='inline-block'; }
}
function doTrace(ip){
  if(!ip){ println('Použitie: traceroute <IP>'); return; }
  const src=currentSrc(); if(!src?.ip){ println('[ERR] Zdroj nemá IP.'); return; }
  const targetDev = resolveDevByIp(ip); if(!targetDev){ println('Cieľ neznámy.'); return; }
  const c=State.ipcfg;
  const hops = [];
  if((src.id==='pc1'||src.id==='pc2') && targetDev==='server'){
    hops.push(c.r_g00.ip, c.r_g01.ip, ip);
  } else if(src.id==='server' && (targetDev==='pc1'||targetDev==='pc2')){
    hops.push(c.r_g01.ip, c.r_g00.ip, ip);
  } else {
    hops.push(ip);
  }
  let ttl=1;
  hops.forEach(h=>{ const t=Math.floor(2+Math.random()*6); println(`${ttl}  ${h}  ${t} ms`); ttl++; });
}
</script>
</body>
</html>
